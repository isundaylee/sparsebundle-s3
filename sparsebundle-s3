#!/usr/bin/env python3

import logging
import sys
import threading
import queue

import sparsebundle_s3.packer as packer
import sparsebundle_s3.uploader as uploader

PACKAGE_COUNT = 0x1
STORAGE_CLASS = 'STANDARD'

logger = logging.getLogger('main')


def usage():
    print('Usage: packer.py bundle-file tmp-dir bucket-name upload-name')
    exit(0)


def main():
    logging.basicConfig(
        format="[%(asctime)-15s] [%(levelname)-8s] [%(name)-8s] %(message)s",
        level=logging.INFO)

    if len(sys.argv) < 5:
        usage()

    bundle = sys.argv[1]
    outdir = sys.argv[2]
    bucket = sys.argv[3]
    name = sys.argv[4]

    package_queue = queue.Queue()
    stop_event = threading.Event()

    packer_thread = threading.Thread(
        target=packer.pack,
        args=(bundle, outdir, PACKAGE_COUNT, package_queue, stop_event))
    uploader_thread = threading.Thread(
        target=uploader.upload,
        args=(bundle, outdir, bucket, name, STORAGE_CLASS, package_queue,
              stop_event))

    packer_thread.start()
    uploader_thread.start()

    try:
        packer_thread.join()
        uploader_thread.join()
    except KeyboardInterrupt:
        stop_event.set()
        logger.info('Stopping...')


main()
